<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart-Garbage ‚Äì Citizen Garbage Report</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #0b1220, #020617);
      overflow-x: hidden;
    }
    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    canvas {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
    }
  </style>
</head>

<body class="text-white min-h-screen flex flex-col items-center justify-center px-6">

  
    <!-- Language Toggle (TOP RIGHT) -->
  <div class="fixed top-4 right-4 z-50 flex gap-2">
    <button
      onclick="setUserLanguage('en')"
      class="px-3 py-1 rounded-lg bg-black/40 hover:bg-black/60 text-sm"
    >
      English
    </button>

    <button
      onclick="setUserLanguage('kn')"
      class="px-3 py-1 rounded-lg bg-black/40 hover:bg-black/60 text-sm"
    >
      ‡≤ï‡≤®‡≥ç‡≤®‡≤°
    </button>
  </div>


  <!-- Three.js Background -->
  <canvas id="bg"></canvas>

  <!-- Hero Section -->
  <section class="text-center max-w-4xl mb-12">
    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4" data-lang="appName2">
      Smart - Garbage Citizen Dahboard
    </h1>
    <p class="text-lg text-slate-300" data-lang="tagline">
      Report garbage issues in your area and help keep the city clean and sustainable.
    </p>
    <p id="citizenId" class="mt-2 text-slate-400 font-medium"></p>
    <button
  onclick="logout()"
  class="mt-4 px-6 py-2 rounded-xl bg-red-500 hover:bg-red-400 text-slate-900 font-semibold transition"
data-lang="logout">
  Logout
</button>


  </section>

  <!-- Main Interactive Card -->
  <section class="glass w-full max-w-3xl rounded-2xl shadow-2xl p-6 md:p-8 transition hover:scale-[1.02]">
    <h2 class="text-xl font-semibold mb-4" data-lang="reportGarbage">Report Garbage Issue</h2>

    <!-- Manual Area Input -->
<input
  id="landmark"
  type="text"
   data-placeholder="enterLandmark"
  placeholder="Enter area / landmark (near bus stop, school, park...)"
  class="w-full mb-3 rounded-lg bg-slate-900/60 border border-slate-700 p-3 focus:outline-none focus:ring-2 focus:ring-emerald-500"
/>

<!-- OR Divider -->
<p class="text-center text-slate-400 mb-3">OR</p>

<!-- Use Current Location -->
<button
  onclick="getLocation()"
  class="mb-2 w-full py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-900 font-semibold transition"
data-lang="useLocation">
  üìç Use Current Location
</button>

<p id="locationStatus" class="text-sm text-slate-400 mb-4"></p>


    <textarea
     id="description"
     rows="3"
     data-placeholder="describeProblem"
     placeholder="Describe the garbage problem..."
     class="w-full rounded-lg bg-slate-900/60 border border-slate-700 p-3 ..."
    ></textarea>


   <label class="block mt-4 mb-2 text-sm text-slate-300" data-lang="update">
  Upload Garbage Photo
</label>

<div class="flex flex-wrap gap-3 mb-4">
  <!-- Camera -->
  <button
    onclick="openCamera()"
    class="px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-900 font-semibold" 
  data-lang="camera">
    üì∑ Open Camera
  </button>

  <button
    onclick="capturePhoto()"
    class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold"
  data-lang="capture">
    üì∏ Capture
  </button>

  <!-- Upload -->
  <label
  for="fileInput"
  class="px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-slate-900 font-semibold cursor-pointer inline-block"
>
  üìÇ Upload File
</label>





</div>

<!-- Camera preview -->
<video id="camera" autoplay playsinline class="hidden w-full rounded-lg mb-3"></video>

<!-- Canvas (hidden) -->
<canvas id="photoCanvas" class="hidden"></canvas>

<!-- Image preview -->
<img
  id="previewImage"
  class="hidden w-full rounded-lg border border-slate-600 mt-2"
/>




    <button
      onclick="submitReport()"
      class="mt-6 w-full py-3 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold transition"
    data-lang="Report2">
      Submit Report
    </button>

    <!-- Loading -->
    <div id="loading" class="hidden mt-4 text-center text-emerald-400 animate-pulse" data-lang="Report3">
      Submitting your report...
    </div>

    <!-- Output Section -->
    <div id="output" class="hidden mt-6 text-center">
      <h3 class="text-lg font-semibold text-emerald-400">
        Report Submitted Successfully
      </h3>
      <p class="text-slate-300 mt-2">
        Municipal authorities will review and take action shortly.
      </p>
    </div>
  </section>
  <!-- Citizen Report Status Section -->
<section class="glass w-full max-w-3xl mt-10 rounded-2xl p-6">
  <h2 class="text-xl font-semibold mb-4" data-lang="yourReports">Your Reports</h2>

  <div id="myReports" class="space-y-4">
    <p class="text-slate-400 text-center">Loading your reports...</p>
  </div>
</section>


  <script>
    

    // Three.js Background (City Particles)
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    const renderer = new THREE.WebGLRenderer({
      canvas: document.getElementById("bg"),
      alpha: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const geometry = new THREE.BufferGeometry();
    const count = 1200;
    const positions = new Float32Array(count * 3);

    for (let i = 0; i < count * 3; i++) {
      positions[i] = (Math.random() - 0.5) * 1200;
    }

    geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
    const material = new THREE.PointsMaterial({
      color: 0x34d399,
      size: 1
    });
    const points = new THREE.Points(geometry, material);
    scene.add(points);

    camera.position.z = 450;

    function animate() {
      requestAnimationFrame(animate);
      points.rotation.y += 0.00035;
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
  <script>
  let userLatitude = null;
let userLongitude = null;
let mapLink = null;

function getLocation() {
  if (!navigator.geolocation) {
    document.getElementById("locationStatus").innerText =
      "Geolocation not supported";
    return;
  }

  document.getElementById("locationStatus").innerText =
    "Fetching location...";

  navigator.geolocation.getCurrentPosition(
    (position) => {
      userLatitude = position.coords.latitude;
      userLongitude = position.coords.longitude;

      mapLink = `https://www.google.com/maps?q=${userLatitude},${userLongitude}`;

      document.getElementById("locationStatus").innerText =
        "Location captured successfully ‚úî";
    },
    () => {
      document.getElementById("locationStatus").innerText =
        "Unable to fetch location";
    }
  );
}

</script>

<script>
let cameraStream = null;
let capturedImageBlob = null;


/* ---------- CAMERA ---------- */
async function openCamera() {
  const video = document.getElementById("camera");
  video.classList.remove("hidden");

  cameraStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });

  video.srcObject = cameraStream;
}

function capturePhoto() {
  const video = document.getElementById("camera");
  const canvas = document.getElementById("photoCanvas");
  const preview = document.getElementById("previewImage");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  canvas.toBlob(blob => {
    capturedImageBlob = blob;
    preview.src = URL.createObjectURL(blob);
    preview.classList.remove("hidden");
  }, "image/jpeg");

  cameraStream.getTracks().forEach(track => track.stop());
  video.classList.add("hidden");
}

/* ---------- FILE UPLOAD ---------- */
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  capturedImageBlob = file;

  const preview = document.getElementById("previewImage");
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
}



</script>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getDatabase, ref, push, onValue, get, set 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { 
  getAuth, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";


/* ---------- Firebase Init ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAfF5WijTd9LbgqrIZDp3imRx36Aeg3OAg",
  authDomain: "smart-garbageapp.firebaseapp.com",
  databaseURL: "https://smart-garbageapp-default-rtdb.firebaseio.com",
  projectId: "smart-garbageapp",
  storageBucket: "smart-garbageapp.firebasestorage.app",
  messagingSenderId: "109287159774",
  appId: "1:109287159774:web:48233baca941db42f78f4f"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

// üì∏ Upload garbage image to Firebase Storage
async function uploadGarbageImage(reportId) {
  if (!capturedImageBlob) return null; // no image uploaded

  const imgRef = storageRef(
    storage,
    `garbageReports/${reportId}.jpg`
  );

  await uploadBytes(imgRef, capturedImageBlob);
  return await getDownloadURL(imgRef);
}



/* ---------- LOGOUT ---------- */
window.logout = function () {
  signOut(auth)
    .then(() => window.location.replace("index.html"))
    .catch(err => alert(err.message));
};

onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  // üëá REQUIRED for language system
  window.currentUser = user;
  loadUserLanguage(user);   // ‚úÖ CORRECT

  // üîπ FIX 1: Handle Google Users who aren't in the "users" database yet
  const userSnap = await get(ref(database, "users/" + user.uid));
  const citizenIdElement = document.getElementById("citizenId");

  if (userSnap.exists()) {
    citizenIdElement.innerText = "Citizen ID: " + userSnap.val().citizenId;
  } else {
    // If Google user, assign a temporary display ID so it's not 'undefined'
    citizenIdElement.innerText = "Logged in as: " + user.email;
  }

  // Load reports
  const reportsRef = ref(database, "reports");
  const myReports = document.getElementById("myReports");

  onValue(reportsRef, (snapshot) => {
    myReports.innerHTML = "";
    let found = false;

    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const r = child.val();
        if (r.citizenEmail !== user.email) return;

        found = true;
        myReports.innerHTML += `
          <div class="glass p-4 rounded-xl mb-3">
            <p><b>Landmark:</b> ${r.landmark}</p>
            ${
              r.mapLink && r.mapLink !== "Manual area only"
                ? `<a href="${r.mapLink}" target="_blank" class="text-sky-400 underline">üìç View Location</a>`
                : `<p class="text-slate-400">Manual area only</p>`
            }
            <p class="mt-2"><b>Status:</b>
              <span class="${r.status === "resolved" ? "text-green-400" : "text-yellow-400"} font-semibold">
                ${r.status}
              </span>
            </p>
          </div>`;
      });
    }

    if (!found) {
      myReports.innerHTML = `<p class="text-slate-400 text-center">No reports yet</p>`;
    }
  });
});

function notifyCollector(landmark, reportId) {
  const notifRef = push(ref(database, "notifications/collector"));

  set(notifRef, {
    message: `New garbage reported near ${landmark}`,
    reportId: reportId,
    timestamp: Date.now(),
    seen: false
  });
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    if (!blob) {
      resolve(null);
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(blob);

    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

/* ---------- SUBMIT REPORT ---------- */
window.submitReport = async function () {
  const landmark = document.getElementById("landmark").value.trim();
  const description = document.getElementById("description").value.trim();
  const loading = document.getElementById("loading");
  const output = document.getElementById("output");

  if (!landmark && (userLatitude === null || userLongitude === null)) {
    alert("Enter landmark OR use current location");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("Login expired. Please login again.");
    return;
  }

  loading.classList.remove("hidden");
  output.classList.add("hidden");

  try {
    const userSnap = await get(ref(database, "users/" + user.uid));
    
    // üîπ FIX 2: Default to 'GOOGLE_USER' instead of letting it break or show 'undefined'
    let citizenNumber = "GUEST";

if (userSnap.exists() && userSnap.val().citizenNumber) {
  citizenNumber = userSnap.val().citizenNumber;
} else {
  // fallback for Google users
  citizenNumber = "G-" + user.uid.substring(0, 6);
}


    // üîπ FIX 3: Corrected the Map Link Syntax (template literals use ${} not 0{})
    const finalMapLink = (userLatitude && userLongitude)
        ? `https://www.google.com/maps?q=${userLatitude},${userLongitude}`
        : "Manual area only";

    const reportRef = push(ref(database, "reports"));
const reportId = reportRef.key;

// üî• convert image to base64
const imageBase64 = await blobToBase64(capturedImageBlob);

await set(reportRef, {
  citizenEmail: user.email,
  citizenNumber: citizenNumber,
  landmark: landmark || "Not provided",
  description: description || "Not provided",
  mapLink: finalMapLink,
  imageBase64: imageBase64 || null, // ‚úÖ KEY CHANGE
  status: "pending",
  timestamp: Date.now()
});

notifyCollector(landmark || "Unknown location", reportId);


capturedImageBlob = null;
document.getElementById("previewImage").classList.add("hidden");


    loading.classList.add("hidden");
    output.classList.remove("hidden");

    // Clear form
    document.getElementById("landmark").value = "";
    document.getElementById("description").value = "";
    document.getElementById("locationStatus").innerText = "";
    userLatitude = userLongitude = null;

  } catch (err) {
    loading.classList.add("hidden");
    console.error(err);
    alert("Submission failed: " + err.message);
  }
};
</script>

<footer class="w-full bg-black/60 mt-20">
  <div class="max-w-6xl mx-auto px-10 py-10">

    <!-- TOP ROW -->
    <div class="flex justify-between items-start">

      <!-- LEFT -->
      <div class="text-left">
        <h2 class="text-emerald-400 text-xl font-semibold mb-2" data-lang="smart">
          Smart-Garbage
        </h2>
        <p class="text-sm mb-4" data-lang="line">
          Building cleaner and smarter cities together.
        </p>

        <h3 class="font-semibold mb-2" data-lang="followUs">Follow Us</h3>
        <p data-lang="Follow1">Instagram</p>
        <p data-lang="Follow2">Twitter</p>
        <p data-lang="Follow3">Facebook</p>
      </div>

      <!-- RIGHT -->
      <div class="text-right">
        <h3 class="font-semibold mb-2" data-lang="contactUs">Contact Us</h3>
        <p data-lang="address">üìç 3rd Cross,5th Main Road, J.P Nagar, Bengaluru, Karnataka, India</p>
        <p data-lang="phoneno">üìû +91 98765 43210 - Anuj P</p>
        <p data-lang="emailadd">‚úâÔ∏è smartgarbage@gmail.com</p>
      </div>

    </div>

    <!-- BOTTOM -->
    <div class="border-t border-white/30 mt-8 pt-4 text-center text-sm" data-lang="rights">
      ¬© 2026 Smart-Garbage. All rights reserved.
    </div>

  </div>
</footer>


<script src="lang.js"></script>


<input
  id="fileInput"
  type="file"
  accept="image/*"
  onchange="handleFileUpload(event)"
  style="
    position: fixed;
    top: 0;
    left: 0;
    opacity: 0;
    z-index: 9999;
  "
/>


</body>
</html>