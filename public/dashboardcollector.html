<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart - Garbage ‚Äì Collector Dashboard</title>
  <!-- ‚úÖ TAB ICON (FAVICON) -->
  <link rel="icon" type="image/png" href="images/logo.png">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #0b1220, #020617);
      overflow-x: hidden;
    }
    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    canvas {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  </style>
</head>

 <body class="text-white min-h-screen px-6 py-10 ">
  <canvas id="bg"></canvas>
  <div class="flex flex-col items-center w-full">


  <!-- Hero Section -->
  <section class="text-center max-w-4xl mx-auto mb-12">

    <!-- üîî Notifications -->
<section class="glass w-full max-w-4xl mx-auto rounded-2xl shadow-xl p-4 mb-10 text-center">

  <h2 class="text-lg font-semibold mb-3">üîî Notifications</h2>
  <ul id="notifList" class="space-y-2 text-sm"></ul>

  <p id="noNotif" class="text-slate-400 hidden">
    No new notifications
  </p>
</section>

    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4" data-lang="appName1">
      Smart - Garbage Collector Dashboard
    </h1>
    <p class="text-lg text-slate-300" data-lang="tagline1">
      
    </p>
    <button data-lang = "logout"
  onclick="logout()"
  class="mt-4 px-6 py-2 rounded-xl bg-red-500 hover:bg-red-400 text-slate-900 font-semibold transition"
>
  Logout
</button>

  </section>

  <!-- Main Interactive Card -->
  <section class="glass w-full max-w-4xl rounded-2xl shadow-2xl p-6 md:p-8 transition hover:scale-[1.02]">
    <h2 class="text-xl font-semibold mb-6" data-lang ="Report1">Assigned Garbage Report</h2>

    <div id="reportsContainer" class="space-y-6"></div>

    <p id="noReports" class="text-center text-slate-400 mt-6 hidden">
    No garbage reports available
    </p>

    </div>

    <!-- Loading -->
    <div id="loading" class="hidden mt-6 text-center text-emerald-400 animate-pulse">
      Updating report status...
    </div>

    <!-- Output -->
    <div id="output" class="hidden mt-6 text-center">
      <h3 class="text-lg font-semibold text-emerald-400">
        Status Updated Successfully
      </h3>
      <p class="text-slate-300 mt-2">
        The report has been processed and updated in the system.
      </p>
    </div>
  </section>

  
<script>
  // Three.js Background (City Operations Particles)
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  const renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById("bg"),
    alpha: true
  });

  renderer.setSize(window.innerWidth, window.innerHeight);

  const geometry = new THREE.BufferGeometry();
  const count = 1300;
  const positions = new Float32Array(count * 3);

  for (let i = 0; i < count * 3; i++) {
    positions[i] = (Math.random() - 0.5) * 1200;
  }

  geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));

  const material = new THREE.PointsMaterial({ color: 0x38bdf8, size: 1 });
  const points = new THREE.Points(geometry, material);
  scene.add(points);

  camera.position.z = 450;

  function animate() {
    requestAnimationFrame(animate);
    points.rotation.y += 0.00035;
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

   
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, update } 
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
  import { 
  getAuth, 
  signOut, 
  
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { push, remove } 
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyAfF5WijTd9LbgqrIZDp3imRx36Aeg3OAg",
  authDomain: "smart-garbageapp.firebaseapp.com",
  databaseURL: "https://smart-garbageapp-default-rtdb.firebaseio.com",
  projectId: "smart-garbageapp",
  storageBucket: "smart-garbageapp.firebasestorage.app",
  messagingSenderId: "109287159774",
  appId: "1:109287159774:web:48233baca941db42f78f4f"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);


import { onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (!user) return;

  window.currentUser = user;     // üîë REQUIRED
  loadUserLanguage(user);      // ‚úÖ CORRECT

   // ‚úÖ THIS LINE WAS MISSING
  listenAssignedReports(user.email);
  listenNotifications(user.uid);
});


const container = document.getElementById("reportsContainer");
const noReports = document.getElementById("noReports");

function listenAssignedReports(collectorEmail) {
  onValue(ref(database, "reports"), (snapshot) => {
    container.innerHTML = "";
    noReports.classList.add("hidden");

    let found = false;

    if (!snapshot.exists()) {
      noReports.classList.remove("hidden");
      return;
    }

    snapshot.forEach((child) => {
      const reportId = child.key;
      const r = child.val();

      // ‚úÖ ONLY assigned to this collector
      if (!r.assignedTo) return;
      if (r.assignedTo !== collectorEmail) return;

      // ‚úÖ Ignore resolved
      if (r.status === "resolved") return;

      found = true;

      const card = document.createElement("div");
      card.className = "glass p-6 rounded-xl";

      card.innerHTML = `
        <p><b>Citizen:</b> ${r.citizenEmail}</p>
        <p><b>Landmark:</b> ${r.landmark}</p>

        <p class="mt-2">
          <b>Description:</b><br>
          <span class="text-slate-300">${r.description}</span>
        </p>

        ${
          r.imageBase64
            ? `<img src="${r.imageBase64}" class="mt-3 rounded-lg border max-h-60 object-cover" />`
            : `<p class="text-slate-400 mt-2">No image</p>`
        }

        ${
          r.mapLink && r.mapLink !== "Manual area only"
            ? `<a href="${r.mapLink}" target="_blank" class="text-sky-400 underline mt-2 inline-block">üìç Open in Google Maps</a>`
            : `<p class="text-slate-400 mt-2">Manual area only</p>`
        }

        <p class="mt-2"><b>Status:</b>
          <span class="text-blue-400 font-semibold">${r.status}</span>
        </p>

        <button
          onclick="markResolved('${reportId}')"
          class="mt-4 w-full py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-black font-semibold">
          Mark as Resolved
        </button>
      `;

       

      container.appendChild(card);
    });

    if (!found) {
      noReports.classList.remove("hidden");
    }
  });
}

function listenNotifications(collectorUid) {
  const notifList = document.getElementById("notifList");
  const noNotif = document.getElementById("noNotif");

  onValue(
    ref(database, `notifications/collectors/${collectorUid}`),
    (snapshot) => {
      notifList.innerHTML = "";
      let hasNotif = false;

      if (!snapshot.exists()) {
        noNotif.classList.remove("hidden");
        return;
      }

      snapshot.forEach((child) => {
        const notif = child.val();
        if (notif.seen) return;

        hasNotif = true;

        const li = document.createElement("li");
        li.className =
          "glass px-4 py-2 rounded-lg hover:bg-white/10 cursor-pointer";

        li.innerHTML = `
          ${notif.message}
          <div class="text-xs text-slate-400">
            ${new Date(notif.timestamp).toLocaleString()}
          </div>
        `;

        li.onclick = () => {
          update(
            ref(database, `notifications/collectors/${collectorUid}/${child.key}`),
            { seen: true }
          );
        };

        notifList.appendChild(li);
      });

      noNotif.classList.toggle("hidden", hasNotif);
    }
  );
}

 

// onValue(ref(database, "reports"), (snapshot) => {
//   container.innerHTML = "";
//   noReports.classList.add("hidden");

//   if (!snapshot.exists()) {
//     noReports.classList.remove("hidden");
//     return;
//   }

//   let found = false;

//   snapshot.forEach((child) => {
//     const reportId = child.key;   // üî• IMPORTANT
//     const r = child.val();

//     const user = auth.currentUser;

// // show ONLY reports assigned to this collector
// if (!r.assignedTo) return;
// if (r.assignedTo !== user.email) return;

// // show only active work
// if (r.status === "resolved") return;



//     found = true;

//     const card = document.createElement("div");
//     card.className = "glass p-6 rounded-xl";

//     card.innerHTML = `
//   <p><b>Citizen ID:</b> ${r.citizenNumber}</p>
//   <p><b>Email:</b> ${r.citizenEmail}</p>
//   <p><b>Landmark:</b> ${r.landmark}</p>

//   <p class="mt-2">
//     <b>Description:</b><br>
//     <span class="text-slate-300">
//       ${r.description || "No description provided"}
//     </span>
//   </p>

//   ${
//   r.imageBase64
//     ? `<img 
//          src="${r.imageBase64}" 
//          class="mt-3 rounded-lg border border-slate-600 max-h-60 object-cover"
//        />`
//     : `<p class="text-slate-400 mt-2">No image uploaded</p>`
// }


//   ${
//     r.mapLink && r.mapLink !== "Manual area only"
//       ? `<a href="${r.mapLink}" target="_blank" class="text-sky-400 underline mt-2 inline-block">
//            üìç Open in Google Maps
//          </a>`
//       : `<p class="text-slate-400 mt-2">Manual area only</p>`
//   }

  

//   <p class="mt-2"><b>Status:</b>
//     <span class="text-yellow-400">${r.status}</span>
//   </p>

//   <button
//     onclick="markResolved('${reportId}')"
//     class="mt-4 w-full py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold">
//     Mark as Resolved
//   </button>
// `;
// // üîî Notification elements
// const notifList = document.getElementById("notifList");
// const noNotif = document.getElementById("noNotif");

// // üîî Listen for notifications
// onValue(ref(database, "notifications/collector"), (snapshot) => {
//   notifList.innerHTML = "";
//   let hasNotif = false;

//   if (!snapshot.exists()) {
//     noNotif.classList.remove("hidden");
//     return;
//   }

//   snapshot.forEach((child) => {
//     const notif = child.val();

//     if (notif.seen) return;

//     hasNotif = true;

//     const li = document.createElement("li");
//     li.className =
//       "glass px-4 py-2 rounded-lg cursor-pointer hover:bg-white/10";

//     li.innerHTML = `
//       üö® ${notif.message}
//       <div class="text-xs text-slate-400 mt-1">
//         ${new Date(notif.timestamp).toLocaleString()}
//       </div>
//     `;

//     li.onclick = () => {
//       // mark as seen
//       update(ref(database, "notifications/collector/" + child.key), {
//         seen: true
//       });
//     };

//     notifList.appendChild(li);
//   });

//   if (!hasNotif) {
//     noNotif.classList.remove("hidden");
//   } else {
//     noNotif.classList.add("hidden");
//   }
// });




//     container.appendChild(card);
//   });

//   if (!found) {
//     noReports.classList.remove("hidden");
//   }
// });

window.markResolved = async function (reportId) {
  const user = auth.currentUser;

  if (!user || !user.email) {
    alert("Collector not logged in properly");
    return;
  }

  await update(ref(database, "reports/" + reportId), {
    status: "resolved",
    resolvedAt: Date.now(),
    resolvedBy: user.email // ‚úÖ GUARANTEED
  });

  alert("Marked as resolved by " + user.email);
};




window.logout = function () {
  signOut(auth)
    .then(() => {
      window.location.replace("index.html");
    })
    .catch((error) => {
      alert("Logout failed: " + error.message);
    });
};

</script>



  <!-- Language Toggle (TOP RIGHT) -->
  <div class="fixed top-4 right-4 z-50 flex gap-2">
    <button
      onclick="setUserLanguage('en')"
      class="px-3 py-1 rounded-lg bg-black/40 hover:bg-black/60 text-sm"
    >
      English
    </button>

    <button
      onclick="setUserLanguage('kn')"
      class="px-3 py-1 rounded-lg bg-black/40 hover:bg-black/60 text-sm"
    >
      ‡≤ï‡≤®‡≥ç‡≤®‡≤°
    </button>
  </div>

<footer class="w-full bg-black/60 mt-20">
  <div class="max-w-6xl mx-auto px-10 py-10">

    <!-- TOP ROW -->
    <div class="flex justify-between items-start">

      <!-- LEFT -->
      <div class="text-left">
        <h2 class="text-emerald-400 text-xl font-semibold mb-2" data-lang="smart">
           Smart-Garbage
        </h2>
        <p class="text-sm mb-4" data-lang="line">
          Building cleaner and smarter cities together.
        </p>

        <h3 class="font-semibold mb-2" data-lang="followUs">Follow Us</h3>
        <p data-lang="Follow1">Instagram</p>
        <p data-lang="Follow2">Twitter</p>
        <p data-lang="Follow3">Facebook</p>
      </div>

      <!-- RIGHT -->
      <div class="text-right">
        <h3 class="font-semibold mb-2" data-lang="contactUs">Contact Us</h3>
        <p data-lang="address">üìç 3rd Cross,5th Main Road, J.P Nagar, Bengaluru, Karnataka, India</p>
        <p data-lang="phoneno">üìû +91 98765 43210 - Anuj P</p>
        <p data-lang="emailadd">‚úâÔ∏è smartgarbage@gmail.com</p>
      </div>

    </div>

    <!-- BOTTOM -->
    <div class="border-t border-white/30 mt-8 pt-4 text-center text-sm" data-lang="rights">
      ¬© 2026 Smart-Garbage. All rights reserved.
    </div>

  </div>
  </div>
</footer>


<script src="lang.js"></script>




</body>
</html>